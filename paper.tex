\documentclass{article}

% Memory address
\newcommand\hex[1]{{\tt #1}}
\newcommand\hexrange[2]{\hex{#1}{\tt -}\hex{#2}}

% Macro to generate neighborhood memory map table
\newcommand\memtable[1]{
\begin{tabular}{lll}
  \hline
  From & To & Contents \\
  \hline
  #1
  \hline
\end{tabular}
}

\newcommand\memrow[4]{
    {\tt {#1}00} & {\tt {#1}FF} & State of cell $(x#2,y#3,z#4)$ \\
}

% The \memxyz macro gives a densely-connected (von Neumann) neighborhood
\newcommand\memz[5]{
  \memrow{#1}{#4}{#5}{-1}
  \memrow{#2}{#4}{#5}{}
  \memrow{#3}{#4}{#5}{+1}
}

\newcommand\memyz[2]{
  \memz{{#1}0}{{#1}1}{{#1}2}{#2}{-1}
  \memz{{#1}4}{{#1}5}{{#1}6}{#2}{}
  \memz{{#1}8}{{#1}9}{{#1}A}{#2}{+1}
}

\newcommand\memxyz{
  \memyz{4}{-1}

  %  \memyz{5}{} includes zero page-mapped cell (x,y,z), which we want to skip, so spell it out without that
  \memz{50}{51}{52}{}{-1}
  \memrow{54}{}{}{-1}
  \memrow{56}{}{}{+1}
  \memz{58}{59}{5A}{}{+1}

  \memyz{6}{+1}
}

% The following table is a sparse neighborhood
\newcommand\vonneumannmap{\memtable{
  \memrow{45}{-1}{}{}
  \memrow{51}{}{-1}{}
  \memrow{54}{}{}{-1}
  \memrow{56}{}{}{+1}
  \memrow{59}{}{+1}{}
  \memrow{65}{+1}{}{}
}}

% The following neighborhood is dense
\newcommand\mooremap{\memtable{\memxyz}}

% Document
\begin{document}

\title{Infinite Cellular Automata Running Virtual 6502 Processors}
\author{Ian Holmes \\ Berkeley, California, USA}

\maketitle


\begin{abstract}
  Cellular automata.
  6502s.
  Blockchain.
\end{abstract}

\section{Cellular automata}

The cellular automaton (CA) is a $L \times L \times L$ array of cells.
Cells are indexed $(x,y,z$) where
$\alpha \leq x \leq \alpha+L$,
$\beta \leq y \leq \beta+L$,
$\gamma \leq z \leq \gamma+L$
and $(\alpha,\beta,\gamma)$ are integers representing global coordinates of this CA.

Each cell has 256 bytes (one ``page'') of state.
All cells' bytes are initially zero, unless otherwise specified
(including, implicitly, cells whose coordinates are outside the CA).
These bytes are the ``storage'' of the virtual machine.

Cells in the CA are updated in a pseudorandom order.
This can be any order that visits all cells uniformly;
a Mersenne Twister is suitable.

A cell $(x,y,z)$ is updated by emulating an 8-bit virtual machine.
The CPU is the MOS Technology 6502 processor.
The memory map is shown in Table~\ref{tab:MemoryMap}.
In this memory map, the 27 pages of storage
for the cell and its 26 neighbors
in the $3 \times 3 \times 3$ unit cube centered on $(x,y,z)$
are mapped directly to bytes in the address range \hexrange{4000}{7FFF} of the virtual machine.

The detailed description of the memory map for this $3 \times 3 \times 3$ neighborhood,
which in cellular automata terminology is
the {\em three-dimensional Moore neighborhood},
is given in Table~\ref{tab:MooreNeighborhood}.

The neighborhood memory map can be understood as the cell $(x+i-1,y+j-1,z+k-1)$
mapping to page number (64+i*16+j*4+k) with $i,j,k \in \{0,1,2\}$.
Thus, in a memory-mapped 16-bit address, the bits have the meanings shown in Table~\ref{tab:AddressBits}.
Note the exception: cell $(x,y,z)$ is not mapped to page 85 (\hexrange{5500}{55FF})
because it is mapped to zero page (\hexrange{0000}{00FF}) instead.

At the beginning of an update,
the registers {\tt A,X,Y} are initialized to zero,
all status flags (register {\tt P}) are set to zero,
the stack pointer (register {\tt SP}) is set to \hex{FF},
the program counter {\tt PC} is set to \hex{0000},
and execution begins at the first byte of zero page.

Execution is terminated
when a software interrupt or undefined instruction is encountered,
or by non-maskable interrupt after a predetermined, but (pseudo)random, number of cycles $C$.
The LSB of $C$ is uniformly distributed;
the MSB is distributed according to a geometric distribution with parameter $\frac{1}{2}$.
Thus, with probability $\frac{1}{2}$, the value of $C$ lies in the range \hexrange{0}{FF};
with probability $\frac{1}{4}$, it lies in the range \hexrange{100}{1FF};
with probability $\frac{1}{8}$ it's in the range \hexrange{200}{2FF};
with probability $\frac{1}{16}$ it's \hexrange{300}{3FF};
and so on.
(It does not overflow when the MSB reaches \hex{FF}, which happens after the heat death of the universe.)
Throughout execution, the {\em remaining} value of this timer
(i.e. the number of cycles from now until termination)
is visible to the program
as the read-only 16-bit value at memory address \hexrange{0400}{0401}.

On termination, the transient address ranges in the memory map
(including the stack)
are discarded.
The neighborhood memory map (\hexrange{4000}{7FFF}, Table~\ref{tab:MooreNeighborhood})
is mapped back to the cellular automata storage.

\begin{table}
\begin{tabular}{llll}
  \hline
  From & To & Type & Contents \\
  \hline
  \hex{0000} & \hex{00FF} & RAM (storage-mapped) & State of cell $(x,y,z)$ \\
  \hex{0100} & \hex{01FF} & RAM (transient) & Stack, initialized to zero \\
  \hex{0200} & \hex{03FF} & RAM (transient) & ``Scratch'' memory, initialized to zero \\
  \hex{0400} & \hex{0401} & ROM (emulator-mapped) & Cycles left before termination \\
  \hex{0402} & \hex{3FFF} & Reserved & Read-only, zero \\
  \hex{4000} & \hex{7FFF} & RAM (storage-mapped) & Memory-mapped neighborhood (Table~\ref{tab:MooreNeighborhood}) \\
  \hex{8000} & \hex{FFFF} & ROM & Read-only (operating system) \\
  \hline
\end{tabular}
\caption{
  \label{tab:MemoryMap}
  Memory map for the 6502 virtual machine of cell $(x,y,z)$.
}
\end{table}

\begin{table}
\mooremap
\caption{
  \label{tab:MooreNeighborhood}
  Memory map for the 6502 virtual machine of cell $(x,y,z)$,
  using the 26-cell three-dimensional Moore neighborhood.
  All address ranges not defined in this table are read-only and zero; writing to them has no effect.
}
\end{table}

\begin{table}
\vonneumannmap
\caption{
  \label{tab:VonNeumannNeighborhood}
  Memory map for the 6502 virtual machine of cell $(x,y,z)$,
  using the 6-cell three-dimensional von Neumann neighborhood.
}
\end{table}

\begin{table}
\begin{tabular}{ll}
  \hline
  Bit(s) & Meaning \\
  \hline
  14,15 & Must be \hex{01} \\
  12,13 & $i$ \\
  10,11 & $j$ \\
  8,9 & $k$ \\
  0-7 & Address within page \\
  \hline
\end{tabular}
\caption{
  Interpretation of an address in the memory-mapped range \hexrange{4000}{7FFF}
  as pointing to a cell $(x+i-1,y+j-1,z+k-1)$.
  See Table~\ref{tab:MooreNeighborhood} and Table~\ref{tab:VonNeumannNeighborhood}.
  Note that $i,j,k, \in \{ 0,1,2 \}$.
  \label{tab:AddressBits}
}
\end{table}




\section{Blockchain description}

\cite{Nakamoto2008}

\section*{Acknowledgments}
Thanks to Peter Irvine, Chris Evans, Richard Evans, Michael Mateas.

\bibliographystyle{plain}
\bibliography{references}

\end{document}
